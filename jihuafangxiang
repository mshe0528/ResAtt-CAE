import numpy as np
import matplotlib.pyplot as plt
import matplotlib as mpl
import os

# è®¾ç½®é«˜è´¨é‡å›¾å½¢å‚æ•°
mpl.rcParams['font.size'] = 10
mpl.rcParams['font.family'] = 'Arial'
mpl.rcParams['axes.labelsize'] = 12
mpl.rcParams['axes.titlesize'] = 14
mpl.rcParams['xtick.labelsize'] = 10
mpl.rcParams['ytick.labelsize'] = 10


def read_mt_data(file_path):
    """
    è¯»å–MTæ•°æ®æ–‡ä»¶
    è¿”å›: Hx, Hy, Ex, Ey æ•°ç»„
    """
    # ä»æ–‡ä»¶åŠ è½½æ•°æ®
    data = np.genfromtxt(file_path)

    # æå–å„åˆ†é‡ (0-indexed)
    Hx = data[:, 6]  # ç¬¬7åˆ—
    Hy = data[:, 7]  # ç¬¬8åˆ—
    Ex = data[:, 13]  # ç¬¬14åˆ—
    Ey = data[:, 14]  # ç¬¬15åˆ—

    return Hx, Hy, Ex, Ey


def calculate_polarization_angles(Ex, Ey, Hx, Hy):
    """
    è®¡ç®—ç”µåœºå’Œç£åœºçš„æåŒ–æ–¹å‘è§’
    è¿”å›: è§’åº¦æ•°ç»„(å•ä½:åº¦)å’Œæ–¹å‘ç»Ÿè®¡
    """
    # è®¡ç®—æ–¹å‘è§’
    theta_E = np.degrees(np.arctan2(Ey, Ex))  # ç”µåœºæ–¹å‘è§’
    theta_H = np.degrees(np.arctan2(Hy, Hx))  # ç£åœºæ–¹å‘è§’

    # è½¬æ¢ä¸º0-360åº¦èŒƒå›´
    theta_E = np.where(theta_E < 0, theta_E + 360, theta_E)
    theta_H = np.where(theta_H < 0, theta_H + 360, theta_H)

    # è®¡ç®—ç»Ÿè®¡å€¼
    stats = {
        'E_mean': np.mean(theta_E),
        'H_mean': np.mean(theta_H),
        'E_std': np.std(theta_E),
        'H_std': np.std(theta_H),
        'E_minmax': (np.min(theta_E), np.max(theta_E)),
        'H_minmax': (np.min(theta_H), np.max(theta_H)),
        'num_points': len(theta_E)
    }

    return theta_E, theta_H, stats


def plot_polarization_rose(theta, title, color, stats=None, bin_size=10, save_dir='output'):
    """
    ç»˜åˆ¶æåŒ–æ–¹å‘ç«ç‘°å›¾
    """
    # åˆ›å»ºåˆ†ç®±
    bins = np.arange(0, 361, bin_size)
    hist, bin_edges = np.histogram(theta, bins=bins)

    # è®¡ç®—é¢‘ç‡ç™¾åˆ†æ¯”
    freq_percent = hist / len(theta) * 100

    # è®¾ç½®é¢œè‰²æ˜ å°„
    cmap = plt.cm.coolwarm if 'E' in title else plt.cm.viridis
    bar_colors = cmap(np.linspace(0.3, 0.8, len(hist)))

    # åˆ›å»ºæåæ ‡å›¾
    fig = plt.figure(figsize=(10, 8), dpi=120)
    ax = fig.add_subplot(111, polar=True, facecolor='whitesmoke')

    # ç»˜å›¾å‚æ•°
    width = np.deg2rad(bin_size)
    theta_rad = np.deg2rad(bins[:-1])
    max_percent = np.max(freq_percent)

    # ç»˜åˆ¶æ¡å½¢
    bars = ax.bar(
        theta_rad, freq_percent,
        width=width,
        bottom=0,
        color=bar_colors,
        edgecolor='k',
        linewidth=0.5,
        alpha=0.85
    )

    # è‡ªå®šä¹‰ç½‘æ ¼å’Œæ ‡ç­¾
    ax.set_theta_zero_location('N')  # 0åº¦æŒ‡å‘åŒ—
    ax.set_theta_direction(-1)  # é¡ºæ—¶é’ˆæ–¹å‘
    ax.set_rgrids(np.arange(0, max_percent + 1, max_percent / 4),
                  labels=[f'{x:.1f}%' for x in np.arange(0, max_percent + 1, max_percent / 4)],
                  fontsize=9)

    # æ·»åŠ æ–¹å‘æ ‡ç­¾
    ax.set_xticks(np.deg2rad([0, 30,60,90,120,150, 180,210,240, 270,300,330]))
    ax.set_xticklabels(['N','NNE','NEE', 'E','SEE','SSE', 'S','SSW','SWW', 'W','NWW','NNW'], fontsize=10)

    # æ·»åŠ æ ‡é¢˜
    plt.title(title, fontsize=14, fontweight='bold', pad=20)

    # æ·»åŠ æ•°æ®ç»Ÿè®¡ä¿¡æ¯
    if stats:
        text_str = (
            f'Mean Direction: {stats["mean"]:.1f}Â°\n'
            f'St. Dev: {stats["std"]:.1f}Â°\n'
            f'Range: {stats["minmax"][0]:.1f}Â°-{stats["minmax"][1]:.1f}Â°\n'
            f'Points: {stats["num_points"]}'
        )
        plt.figtext(0.75, 0.15, text_str, bbox=dict(facecolor='white', alpha=0.7))

    # æ·»åŠ é¢œè‰²æ¡
    sm = plt.cm.ScalarMappable(cmap=cmap, norm=plt.Normalize(vmin=0, vmax=360))
    sm.set_array([])
    cbar = plt.colorbar(sm, ax=ax, pad=0.1)
    cbar.set_label('Direction (Â°)', fontsize=10)

    # ä¿å­˜å›¾åƒ
    os.makedirs(save_dir, exist_ok=True)
    filename = title.lower().replace(' ', '_').replace('(', '').replace(')', '') + '.png'
    plt.savefig(os.path.join(save_dir, filename), dpi=300, bbox_inches='tight')
    plt.close()

    return os.path.join(save_dir, filename)


def generate_polarization_report(file_path, bin_size=10):
    """
    å¤„ç†MTæ•°æ®å¹¶ç”ŸæˆæåŒ–æ–¹å‘ç«ç‘°å›¾æŠ¥å‘Š
    """
    # è¯»å–æ•°æ®
    Hx, Hy, Ex, Ey = read_mt_data(file_path)

    # è®¡ç®—æåŒ–æ–¹å‘
    theta_E, theta_H, stats = calculate_polarization_angles(Ex, Ey, Hx, Hy)

    # å‡†å¤‡ç»Ÿè®¡ä¿¡æ¯
    e_stats = {
        'mean': stats['E_mean'],
        'std': stats['E_std'],
        'minmax': stats['E_minmax'],
        'num_points': stats['num_points']
    }

    h_stats = {
        'mean': stats['H_mean'],
        'std': stats['H_std'],
        'minmax': stats['H_minmax'],
        'num_points': stats['num_points']
    }

    # åˆ›å»ºè¾“å‡ºç›®å½•
    output_dir = os.path.join(os.path.dirname(file_path), 'polarization_analysis')
    os.makedirs(output_dir, exist_ok=True)

    # ç”Ÿæˆç”µåœºæåŒ–ç«ç‘°å›¾
    e_plot_path = plot_polarization_rose(
        theta_E,
        title='Electric Field Polarization Direction',
        color='blue',
        stats=e_stats,
        bin_size=bin_size,
        save_dir=output_dir
    )

    # ç”Ÿæˆç£åœºæåŒ–ç«ç‘°å›¾
    h_plot_path = plot_polarization_rose(
        theta_H,
        title='Magnetic Field Polarization Direction',
        color='red',
        stats=h_stats,
        bin_size=bin_size,
        save_dir=output_dir
    )

    # ç”Ÿæˆæ•°æ®è´¨é‡æŠ¥å‘Š
    quality_report = generate_quality_report(e_stats, h_stats)

    return e_plot_path, h_plot_path, quality_report


def generate_quality_report(e_stats, h_stats):
    """
    ç”ŸæˆMTæ•°æ®è´¨é‡è¯„ä¼°æŠ¥å‘Š
    """
    quality_messages = []

    # è¯„ä¼°ç”µåœºè´¨é‡
    if e_stats['std'] < 5:
        e_quality = "Excellent"
    elif e_stats['std'] < 10:
        e_quality = "Good"
    elif e_stats['std'] < 20:
        e_quality = "Fair"
    else:
        e_quality = "Poor"

    quality_messages.append(f"âš¡ Electric Field Direction Quality: {e_quality}")
    quality_messages.append(f"  - Direction: Mean = {e_stats['mean']:.1f}Â°, Std Dev = {e_stats['std']:.1f}Â°")
    quality_messages.append(f"  - Range: {e_stats['minmax'][0]:.1f}Â° to {e_stats['minmax'][1]:.1f}Â°")

    # è¯„ä¼°ç£åœºè´¨é‡
    if h_stats['std'] < 0.5:
        h_quality = "Excellent"
    elif h_stats['std'] < 2:
        h_quality = "Good"
    elif h_stats['std'] < 5:
        h_quality = "Fair"
    else:
        h_quality = "Poor"

    quality_messages.append(f"\nğŸ§² Magnetic Field Direction Quality: {h_quality}")
    quality_messages.append(f"  - Direction: Mean = {h_stats['mean']:.1f}Â°, Std Dev = {h_stats['std']:.1f}Â°")
    quality_messages.append(f"  - Range: {h_stats['minmax'][0]:.1f}Â° to {h_stats['minmax'][1]:.1f}Â°")

    # æ•´ä½“è´¨é‡è¯„ä¼°
    if "Poor" in e_quality or "Poor" in h_quality:
        overall_quality = "âš ï¸ Low Quality - Significant noise detected"
        recommendation = ("Recommendations:\n"
                          "1. Inspect raw time series for transient noise\n"
                          "2. Apply bandpass filtering\n"
                          "3. Consider removing corrupted time segments")
    elif "Fair" in e_quality or "Fair" in h_quality:
        overall_quality = "âš ï¸ Moderate Quality - Some noise present"
        recommendation = ("Recommendations:\n"
                          "1. Apply selective filtering\n"
                          "2. Increase stacking for noise reduction\n"
                          "3. Verify sensor coupling")
    else:
        overall_quality = "âœ… High Quality - Minimal noise detected"
        recommendation = "Data quality is sufficient for analysis"

    quality_messages.append(f"\nOverall Data Quality: {overall_quality}")
    quality_messages.append(f"\n{recommendation}")

    return "\n".join(quality_messages)


# ä¸»ç¨‹åº
if __name__ == "__main__":
    # è®¾ç½®å‚æ•°
    MT_DATA_FILE = "D:/LMTlongmenshan_data/compare/longmens_36_100/all/all.txt"  # æ›¿æ¢ä¸ºä½ çš„æ•°æ®æ–‡ä»¶è·¯å¾„
    BIN_SIZE = 15  # ç«ç‘°å›¾çš„åˆ†ç®±å¤§å°ï¼ˆåº¦ï¼‰

    # å¤„ç†æ•°æ®å¹¶ç”Ÿæˆå›¾å½¢
    e_plot, h_plot, report = generate_polarization_report(MT_DATA_FILE, bin_size=BIN_SIZE)

    # æ‰“å°ç»“æœ
    print("=" * 80)
    print("MT DATA POLARIZATION ANALYSIS REPORT")
    print("=" * 80)
    print(f"Data file processed: {MT_DATA_FILE}")
    print(f"Number of points: {len(np.genfromtxt(MT_DATA_FILE))}")
    print("\nElectric field polarization plot saved to:")
    print(f"  {e_plot}")
    print("\nMagnetic field polarization plot saved to:")
    print(f"  {h_plot}")
    print("\n" + "-" * 80)
    print("DATA QUALITY ASSESSMENT:")
    print("-" * 80)
    print(report)
    print("=" * 80)
